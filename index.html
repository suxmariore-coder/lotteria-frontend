<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Lotteria 1-90</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; text-align: center; }
    #grid { width: 90%; margin: 20px auto; display: grid; grid-template-columns: repeat(10, 1fr); gap: 8px; }
    .cell {
      padding: 15px;
      border-radius: 10px;
      background: #4CAF50;
      color: white;
      font-size: 18px;
      cursor: pointer;
      transition: 0.2s;
    }
    .cell.red { background: #d9534f !important; }
    .cell:hover { transform: scale(1.05); }

    /* Finestra modale */
    #modal {
      position: fixed; left: 0; top: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center;
    }
    #modalContent {
      background: white; padding: 25px; width: 300px; border-radius: 12px;
      box-shadow: 0 0 10px black;
    }
    input, button { width: 100%; padding: 10px; margin-top: 10px; font-size: 16px; }

    #adminPanel { margin-top: 30px; }
  </style>
</head>
<body>

  <h1>Lotteria 1-90</h1>

  <!-- Griglia -->
  <div id="grid"></div>

  <!-- Modal -->
  <div id="modal">
    <div id="modalContent">
      <h3 id="modalTitle"></h3>
      <input type="text" id="buyerName" placeholder="Il tuo nome">
      <button style="background:#0070ba;color:white;" id="paypalBtn">Paga con PayPal</button>
      <button style="background:#ff4b4b;color:white;" id="revolutBtn">Paga con Revolut</button>
      <button onclick="closeModal()">Chiudi</button>
    </div>
  </div>

  <!-- Admin -->
  <div id="adminPanel">
    <input type="password" id="adminPwd" placeholder="Password Admin">
    <button onclick="resetAll()">Reset Totale</button>
  </div>

<script>
const API = "https://lotteria-backend-ar6m.onrender.com";
let selectedNumber = null;

/* ============================
   CARICA I NUMERI
============================ */
async function loadNumbers() {
  const res = await fetch(API + "/numbers");
  const numbers = await res.json();

  const grid = document.getElementById("grid");
  grid.innerHTML = ""; 

  numbers.forEach(n => {
    const div = document.createElement("div");
    div.className = "cell" + (n.acquistato ? " red" : "");
    div.textContent = n.numero;

    div.onclick = () => openModal(n.numero, n.acquistato);

    grid.appendChild(div);
  });
}

/* ============================
   MODAL
============================ */
function openModal(numero, isRed) {
  selectedNumber = numero;

  if (isRed) {
    alert("Numero giÃ  acquistato!");
    return;
  }

  document.getElementById("modalTitle").textContent = "Numero selezionato: " + numero;
  document.getElementById("buyerName").value = "";
  document.getElementById("modal").style.display = "flex";
}

function closeModal() {
  document.getElementById("modal").style.display = "none";
}

/* ============================
   CONFERMA AUTOMATICA
============================ */
async function confirmPurchase(method) {
  const nome = document.getElementById("buyerName").value.trim();

  if (!nome) {
    alert("Inserisci il nome");
    return;
  }

  await fetch(API + "/confirm", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ 
      numero: selectedNumber, 
      nome_acquirente: nome 
    })
  });

  closeModal();
  loadNumbers();
}

/* CLICK SU PAYPAL O REVOLUT = conferma immediata */
document.getElementById("paypalBtn").onclick = () => confirmPurchase("paypal");
document.getElementById("revolutBtn").onclick = () => confirmPurchase("revolut");

/* ============================
   RESET TOTALE (ADMIN)
============================ */
async function resetAll() {
  const pwd = document.getElementById("adminPwd").value;

  if (pwd !== "reimar2002") {
    alert("Password sbagliata!");
    return;
  }

  if (!confirm("Sicuro di voler resettare tutto?")) return;

  for (let i = 1; i <= 90; i++) {
    await fetch(API + "/reset", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ numero: i })
    });
  }

  alert("Griglia resettata!");
  loadNumbers();
}

/* ============================
   AVVIO
============================ */
loadNumbers();
setInterval(loadNumbers, 3000);
</script>

</body>
</html>
